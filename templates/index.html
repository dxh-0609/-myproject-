<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title data-en="Server Monitor System" data-zh="服务器监控系统">服务器监控系统</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #1890ff;
            --danger-color: #ff4d4f;
            --warning-color: #faad14;
            --success-color: #52c41a;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #333333;
            --border-color: #d9d9d9;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 0; 
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s;
        }

        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 20px; 
        }

        .header { 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .controls { 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .alert-panel {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid var(--danger-color);
        }

        .alert-item {
            padding: 10px;
            margin: 5px 0;
            background: #fff2f0;
            border-radius: 4px;
            border-left: 3px solid var(--danger-color);
        }

        .chart-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr)); 
            gap: 20px; 
            margin-bottom: 20px; 
        }

        .chart { 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            height: 400px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
            transition: all 0.3s;
        }

        .btn-primary { background: var(--primary-color); color: white; }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-warning { background: var(--warning-color); color: white; }
        .btn-success { background: var(--success-color); color: white; }

        .btn:hover { opacity: 0.8; }

        .control-group {
            margin: 10px 0;
        }

        select, input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin: 0 5px;
        }

        .language-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .tab-container {
            margin: 20px 0;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            border-bottom: 2px solid transparent;
        }

        .tab-button.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
        }

        .tab-content {
            display: none;
            padding: 20px 0;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 data-en="Server Monitor System" data-zh="服务器监控系统">服务器监控系统</h1>
            <div class="language-switcher">
                <button class="btn" onclick="switchLanguage('zh')">中文</button>
                <button class="btn" onclick="switchLanguage('en')">English</button>
            </div>
        </div>

        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('monitor')" data-en="Real-time Monitor" data-zh="实时监控">实时监控</button>
                <button class="tab-button" onclick="switchTab('history')" data-en="History Data" data-zh="历史数据">历史数据</button>
                <button class="tab-button" onclick="switchTab('export')" data-en="Data Export" data-zh="数据导出">数据导出</button>
                <button class="tab-button" onclick="switchTab('alerts')" data-en="Alerts" data-zh="告警管理">告警管理</button>
            </div>

            <!-- 实时监控标签 -->
            <div id="monitor-tab" class="tab-content active">
                <div class="controls">
                    <div class="control-group">
                        <select id="hostSelect">
                            <option value="" data-en="Select Host..." data-zh="选择主机...">选择主机...</option>
                        </select>
                        <button class="btn btn-primary" onclick="addChart()" data-en="Add Chart" data-zh="添加图表">添加图表</button>
                        <button class="btn btn-danger" onclick="clearCharts()" data-en="Clear All" data-zh="清空所有">清空所有</button>
                    </div>
                </div>

                <div id="alertPanel" class="alert-panel" style="display: none;">
                    <h3 data-en="Active Alerts" data-zh="活跃告警">活跃告警</h3>
                    <div id="alertList"></div>
                </div>

                <div id="chartContainer" class="chart-container"></div>
            </div>

            <!-- 历史数据标签 -->
            <div id="history-tab" class="tab-content">
                <div class="controls">
                    <div class="control-group">
                        <select id="historyHostSelect">
                            <option value="" data-en="All Hosts" data-zh="所有主机">所有主机</option>
                        </select>
                        <select id="historyHours">
                            <option value="1" data-en="Last 1 Hour" data-zh="最近1小时">最近1小时</option>
                            <option value="6" data-en="Last 6 Hours" data-zh="最近6小时">最近6小时</option>
                            <option value="24" selected data-en="Last 24 Hours" data-zh="最近24小时">最近24小时</option>
                            <option value="168" data-en="Last 7 Days" data-zh="最近7天">最近7天</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadHistoryData()" data-en="Load Data" data-zh="加载数据">加载数据</button>
                    </div>
                </div>
                <div id="historyChartContainer" class="chart-container"></div>
            </div>

            <!-- 数据导出标签 -->
            <div id="export-tab" class="tab-content">
                <div class="controls">
                    <div class="control-group">
                        <select id="exportHostSelect">
                            <option value="" data-en="All Hosts" data-zh="所有主机">所有主机</option>
                        </select>
                        <select id="exportHours">
                            <option value="1" data-en="Last 1 Hour" data-zh="最近1小时">最近1小时</option>
                            <option value="6" data-en="Last 6 Hours" data-zh="最近6小时">最近6小时</option>
                            <option value="24" selected data-en="Last 24 Hours" data-zh="最近24小时">最近24小时</option>
                            <option value="168" data-en="Last 7 Days" data-zh="最近7天">最近7天</option>
                        </select>
                        <button class="btn btn-success" onclick="exportCSV()" data-en="Export CSV" data-zh="导出CSV">导出CSV</button>
                        <button class="btn btn-primary" onclick="exportExcel()" data-en="Export Excel" data-zh="导出Excel">导出Excel</button>
                        <button class="btn btn-warning" onclick="generateReport()" data-en="Generate Report" data-zh="生成报告">生成报告</button>
                    </div>
                </div>
            </div>

            <!-- 告警管理标签 -->
            <div id="alerts-tab" class="tab-content">
                <div class="controls">
                    <div class="control-group">
                        <button class="btn btn-primary" onclick="loadAlerts()" data-en="Refresh Alerts" data-zh="刷新告警">刷新告警</button>
                        <button class="btn btn-danger" onclick="resolveAllAlerts()" data-en="Resolve All" data-zh="解决所有">解决所有</button>
                    </div>
                </div>
                <div id="alertsList" class="alert-panel"></div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentLanguage = 'zh';
        let hostCharts = new Map();
        let currentCharts = [];
        let historyCharts = new Map();

        // 语言切换
        function switchLanguage(lang) {
            currentLanguage = lang;
            document.querySelectorAll('[data-zh]').forEach(element => {
                if (lang === 'zh') {
                    element.textContent = element.getAttribute('data-zh');
                } else {
                    element.textContent = element.getAttribute('data-en');
                }
            });
            // 更新图表标题等
            updateChartsLanguage();
        }

        function updateChartsLanguage() {
            hostCharts.forEach((chartInfo, host) => {
                const option = chartInfo.chart.getOption();
                option.title[0].text = currentLanguage === 'zh' ? 
                    `${host} - CPU & 内存使用率` : `${host} - CPU & Memory Usage`;
                option.legend[0].data = currentLanguage === 'zh' ? 
                    ['CPU使用率', '内存使用率'] : ['CPU Usage', 'Memory Usage'];
                option.xAxis[0].name = currentLanguage === 'zh' ? '时间' : 'Time';
                option.yAxis[0].name = currentLanguage === 'zh' ? '使用率(%)' : 'Usage (%)';
                chartInfo.chart.setOption(option);
            });
        }

        // 标签切换
        function switchTab(tabName) {
            // 隐藏所有标签内容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            // 取消所有标签按钮激活状态
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            // 显示选中的标签
            document.getElementById(`${tabName}-tab`).classList.add('active');
            // 激活对应的按钮
            event.target.classList.add('active');
        }

        // 初始化主机选择下拉框
        function initHostSelect() {
            fetch('/api/hosts')
                .then(response => response.json())
                .then(hosts => {
                    updateSelectOptions('hostSelect', hosts);
                    updateSelectOptions('historyHostSelect', hosts, true);
                    updateSelectOptions('exportHostSelect', hosts, true);
                });
        }

        function updateSelectOptions(selectId, hosts, includeAll = false) {
            const select = document.getElementById(selectId);
            // 清空现有选项（保留第一个）
            while (select.children.length > (includeAll ? 0 : 1)) {
                select.removeChild(select.lastChild);
            }
            // 添加所有主机选项
            if (includeAll) {
                const allOption = document.createElement('option');
                allOption.value = '';
                allOption.textContent = currentLanguage === 'zh' ? '所有主机' : 'All Hosts';
                select.appendChild(allOption);
            }
            // 添加主机选项
            hosts.forEach(host => {
                const option = document.createElement('option');
                option.value = host;
                option.textContent = host;
                select.appendChild(option);
            });
        }

        // 实时监控图表功能
        function addChart() {
            const hostSelect = document.getElementById('hostSelect');
            const selectedHost = hostSelect.value;
            
            if (!selectedHost) {
                alert(currentLanguage === 'zh' ? '请先选择主机' : 'Please select a host first');
                return;
            }
            
            if (hostCharts.has(selectedHost)) {
                alert(currentLanguage === 'zh' ? '该主机监控图表已存在' : 'Chart for this host already exists');
                return;
            }
            
            // 创建图表容器
            const chartId = 'chart-' + Date.now();
            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart';
            chartDiv.id = chartId;
            document.getElementById('chartContainer').appendChild(chartDiv);
            
            // 初始化图表
            const chart = echarts.init(chartDiv);
            const option = {
                title: { 
                    text: currentLanguage === 'zh' ? 
                        `${selectedHost} - CPU & 内存使用率` : 
                        `${selectedHost} - CPU & Memory Usage`,
                    left: 'center'
                },
                tooltip: { 
                    trigger: 'axis',
                    formatter: currentLanguage === 'zh' ? 
                        function(params) {
                            let result = params[0].name + '<br/>';
                            params.forEach(param => {
                                result += `${param.seriesName}: ${param.value}%<br/>`;
                            });
                            return result;
                        } : undefined
                },
                legend: { 
                    data: currentLanguage === 'zh' ? 
                        ['CPU使用率', '内存使用率'] : 
                        ['CPU Usage', 'Memory Usage'],
                    top: 30
                },
                xAxis: { 
                    type: 'category', 
                    data: [],
                    name: currentLanguage === 'zh' ? '时间' : 'Time'
                },
                yAxis: { 
                    type: 'value', 
                    max: 100,
                    name: currentLanguage === 'zh' ? '使用率(%)' : 'Usage (%)'
                },
                series: [
                    { 
                        name: currentLanguage === 'zh' ? 'CPU使用率' : 'CPU Usage', 
                        type: 'line', 
                        data: [],
                        smooth: true,
                        lineStyle: { width: 3 }
                    },
                    { 
                        name: currentLanguage === 'zh' ? '内存使用率' : 'Memory Usage', 
                        type: 'line', 
                        data: [],
                        smooth: true,
                        lineStyle: { width: 3 }
                    }
                ]
            };
            chart.setOption(option);
            
            // 存储图表实例
            hostCharts.set(selectedHost, { chart, chartId });
            currentCharts.push({ host: selectedHost, chart, chartId });
            
            // 更新图表数据
            updateChartData(selectedHost);
        }

        function updateChartData(host) {
            if (!hostCharts.has(host)) return;
            
            fetch(`/api/data?host=${host}`)
                .then(response => response.json())
                .then(data => {
                    const times = data.map(item => item.time);
                    const cpu_data = data.map(item => item.cpu);
                    const mem_data = data.map(item => item.memory);
                    
                    const { chart } = hostCharts.get(host);
                    chart.setOption({
                        xAxis: { data: times },
                        series: [
                            { data: cpu_data },
                            { data: mem_data }
                        ]
                    });
                });
        }

        function clearCharts() {
            currentCharts.forEach(({ chartId }) => {
                const element = document.getElementById(chartId);
                if (element) {
                    element.remove();
                }
            });
            hostCharts.clear();
            currentCharts = [];
        }

        // 告警功能
        function loadAlerts() {
            fetch('/api/alerts')
                .then(response => response.json())
                .then(alerts => {
                    const alertsList = document.getElementById('alertsList');
                    if (alerts.length === 0) {
                        alertsList.innerHTML = '<p>' + (currentLanguage === 'zh' ? '没有活跃告警' : 'No active alerts') + '</p>';
                        document.getElementById('alertPanel').style.display = 'none';
                        return;
                    }
                    
                    document.getElementById('alertPanel').style.display = 'block';
                    let html = '<h3>' + (currentLanguage === 'zh' ? '活跃告警' : 'Active Alerts') + '</h3>';
                    alerts.forEach(alert => {
                        html += `
                            <div class="alert-item">
                                <strong>${alert.host}</strong> - ${alert.message}
                                <small>(${new Date(alert.timestamp).toLocaleString()})</small>
                                <button class="btn btn-success" onclick="resolveAlert(${alert.id})" style="float: right; padding: 2px 8px; font-size: 12px;">
                                    ${currentLanguage === 'zh' ? '解决' : 'Resolve'}
                                </button>
                            </div>
                        `;
                    });
                    alertsList.innerHTML = html;
                    
                    // 更新实时监控的告警面板
                    document.getElementById('alertList').innerHTML = html;
                });
        }

        function resolveAlert(alertId) {
            fetch(`/api/alerts/${alertId}/resolve`, { method: 'POST' })
                .then(response => response.json())
                .then(() => {
                    loadAlerts();
                });
        }

        function resolveAllAlerts() {
            if (confirm(currentLanguage === 'zh' ? '确定要解决所有告警吗？' : 'Are you sure you want to resolve all alerts?')) {
                fetch('/api/alerts')
                    .then(response => response.json())
                    .then(alerts => {
                        alerts.forEach(alert => {
                            resolveAlert(alert.id);
                        });
                    });
            }
        }

        // 历史数据功能
        function loadHistoryData() {
            const host = document.getElementById('historyHostSelect').value;
            const hours = document.getElementById('historyHours').value;
            
            fetch(`/api/history?host=${host || ''}&hours=${hours}`)
                .then(response => response.json())
                .then(data => {
                    // 按主机分组数据
                    const hostData = {};
                    data.forEach(item => {
                        if (!hostData[item.host]) {
                            hostData[item.host] = [];
                        }
                        hostData[item.host].push(item);
                    });
                    
                    // 创建或更新图表
                    const container = document.getElementById('historyChartContainer');
                    container.innerHTML = '';
                    historyCharts.clear();
                    
                    Object.keys(hostData).forEach(host => {
                        const chartId = 'history-chart-' + host;
                        const chartDiv = document.createElement('div');
                        chartDiv.className = 'chart';
                        chartDiv.id = chartId;
                        container.appendChild(chartDiv);
                        
                        const chart = echarts.init(chartDiv);
                        const hostDataSorted = hostData[host].sort((a, b) => new Date(a.time) - new Date(b.time));
                        
                        const times = hostDataSorted.map(item => {
                            const date = new Date(item.time);
                            return date.toLocaleTimeString();
                        });
                        const cpu_data = hostDataSorted.map(item => item.cpu);
                        const mem_data = hostDataSorted.map(item => item.memory);
                        
                        const option = {
                            title: { 
                                text: currentLanguage === 'zh' ? 
                                    `${host} - 历史数据` : 
                                    `${host} - History Data`,
                                left: 'center'
                            },
                            tooltip: { trigger: 'axis' },
                            legend: { 
                                data: currentLanguage === 'zh' ? 
                                    ['CPU使用率', '内存使用率'] : 
                                    ['CPU Usage', 'Memory Usage'],
                                top: 30
                            },
                            xAxis: { 
                                type: 'category', 
                                data: times,
                                name: currentLanguage === 'zh' ? '时间' : 'Time'
                            },
                            yAxis: { 
                                type: 'value', 
                                max: 100,
                                name: currentLanguage === 'zh' ? '使用率(%)' : 'Usage (%)'
                            },
                            series: [
                                { 
                                    name: currentLanguage === 'zh' ? 'CPU使用率' : 'CPU Usage', 
                                    type: 'line', 
                                    data: cpu_data,
                                    smooth: true
                                },
                                { 
                                    name: currentLanguage === 'zh' ? '内存使用率' : 'Memory Usage', 
                                    type: 'line', 
                                    data: mem_data,
                                    smooth: true
                                }
                            ]
                        };
                        chart.setOption(option);
                        historyCharts.set(host, chart);
                    });
                });
        }

        // 数据导出功能
        function exportCSV() {
            const host = document.getElementById('exportHostSelect').value;
            const hours = document.getElementById('exportHours').value;
            window.open(`/api/export/csv?host=${host || ''}&hours=${hours}`);
        }

        function exportExcel() {
            // 简化版 - 实际可以使用SheetJS库
            alert(currentLanguage === 'zh' ? 'Excel导出功能开发中...' : 'Excel export feature in development...');
        }

        function generateReport() {
            // 生成监控报告
            const host = document.getElementById('exportHostSelect').value;
            const hours = document.getElementById('exportHours').value;
            
            fetch(`/api/history?host=${host || ''}&hours=${hours}`)
                .then(response => response.json())
                .then(data => {
                    // 生成简单的HTML报告
                    const reportWindow = window.open('', '_blank');
                    const reportContent = `
                        <html>
                            <head><title>${currentLanguage === 'zh' ? '监控报告' : 'Monitor Report'}</title></head>
                            <body>
                                <h1>${currentLanguage === 'zh' ? '服务器监控报告' : 'Server Monitor Report'}</h1>
                                <p>${currentLanguage === 'zh' ? '生成时间：' : 'Generated: '}${new Date().toLocaleString()}</p>
                                <p>${currentLanguage === 'zh' ? '监控时段：最近' : 'Period: Last '}${hours}${currentLanguage === 'zh' ? '小时' : ' hours'}</p>
                                ${host ? `<p>${currentLanguage === 'zh' ? '主机：' : 'Host: '}${host}</p>` : ''}
                                <h2>${currentLanguage === 'zh' ? '统计信息' : 'Statistics'}</h2>
                                ${generateStatistics(data)}
                            </body>
                        </html>
                    `;
                    reportWindow.document.write(reportContent);
                });
        }

        function generateStatistics(data) {
            if (data.length === 0) {
                return '<p>' + (currentLanguage === 'zh' ? '没有数据' : 'No data') + '</p>';
            }
            
            // 按主机分组计算统计信息
            const hostStats = {};
            data.forEach(item => {
                if (!hostStats[item.host]) {
                    hostStats[item.host] = { cpu: [], memory: [] };
                }
                hostStats[item.host].cpu.push(item.cpu);
                hostStats[item.host].memory.push(item.memory);
            });
            
            let html = '';
            Object.keys(hostStats).forEach(host => {
                const cpuData = hostStats[host].cpu;
                const memData = hostStats[host].memory;
                
                html += `
                    <h3>${host}</h3>
                    <table border="1" style="border-collapse: collapse; width: 100%;">
                        <tr>
                            <th>${currentLanguage === 'zh' ? '指标' : 'Metric'}</th>
                            <th>${currentLanguage === 'zh' ? '平均值' : 'Average'}</th>
                            <th>${currentLanguage === 'zh' ? '最大值' : 'Max'}</th>
                            <th>${currentLanguage === 'zh' ? '最小值' : 'Min'}</th>
                        </tr>
                        <tr>
                            <td>${currentLanguage === 'zh' ? 'CPU使用率' : 'CPU Usage'}</td>
                            <td>${(cpuData.reduce((a, b) => a + b, 0) / cpuData.length).toFixed(2)}%</td>
                            <td>${Math.max(...cpuData).toFixed(2)}%</td>
                            <td>${Math.min(...cpuData).toFixed(2)}%</td>
                        </tr>
                        <tr>
                            <td>${currentLanguage === 'zh' ? '内存使用率' : 'Memory Usage'}</td>
                            <td>${(memData.reduce((a, b) => a + b, 0) / memData.length).toFixed(2)}%</td>
                            <td>${Math.max(...memData).toFixed(2)}%</td>
                            <td>${Math.min(...memData).toFixed(2)}%</td>
                        </tr>
                    </table>
                `;
            });
            
            return html;
        }

        // 定时更新
        function updateAllCharts() {
            currentCharts.forEach(({ host }) => {
                updateChartData(host);
            });
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initHostSelect();
            loadAlerts();
            
            // 定时更新
            setInterval(initHostSelect, 10000);
            setInterval(updateAllCharts, 2000);
            setInterval(loadAlerts, 30000);
        });
    </script>
</body>
</html>
